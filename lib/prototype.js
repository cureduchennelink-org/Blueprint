// Generated by CoffeeScript 1.9.2
(function() {
  var Promise, Prototype, PrototypeModule, _,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Promise = require('bluebird');

  _ = require('lodash');

  Prototype = (function() {
    Prototype.deps = {
      services: ['push', 'wrapper'],
      config: 'prototype[modules,clear_psets_on_restart]'
    };

    function Prototype(kit) {
      var f;
      f = 'Prototype:constructor';
      this.config = kit.services.config.prototype;
    }

    Prototype.prototype.server_init = function(kit) {
      var clear_pset, f, i, len, mod, protos, push, q_result, wrapper;
      f = 'Prototype:server_init:';
      push = kit.services.push;
      wrapper = kit.services.wrapper;
      protos = this.config.modules;
      clear_pset = this.config.clear_psets_on_restart;
      q_result = Promise.resolve().bind(this);
      for (i = 0, len = protos.length; i < len; i++) {
        mod = protos[i];
        if (mod.enable) {
          (function(mod) {
            return q_result = q_result.then(function() {
              return push.GetPushSet(clear_pset, "Prototype/" + mod.name);
            }).then(function(pset) {
              kit.add_route_service(mod.name, new PrototypeModule(mod, pset));
              return wrapper.add(mod.name);
            });
          })(mod);
        }
      }
      return q_result;
    };

    return Prototype;

  })();

  PrototypeModule = (function() {
    function PrototypeModule(mod1, pset1) {
      var counter, dataset, f, i, idx, len, nm, rec, ref, ref1, ref2, ref3;
      this.mod = mod1;
      this.pset = pset1;
      this.S_Delete = bind(this.S_Delete, this);
      this.S_Update = bind(this.S_Update, this);
      this.S_Create = bind(this.S_Create, this);
      this.S_Get = bind(this.S_Get, this);
      f = "PrototypeModule:constructor:";
      this.resource = {};
      this.endpoints = {};
      this.endpoints["get" + this.mod.name] = {
        verb: 'get',
        route: "/Prototype/" + this.mod.name,
        use: true,
        wrap: 'default_wrap',
        version: {
          any: this.S_Get
        },
        sql_conn: true,
        sql_tx: true,
        auth_required: this.mod.auth_req
      };
      ref = this.mod.datasets;
      for (nm in ref) {
        dataset = ref[nm];
        idx = {};
        counter = 0;
        ref3 = (ref1 = (ref2 = this.mod.data) != null ? ref2[nm] : void 0) != null ? ref1 : [];
        for (i = 0, len = ref3.length; i < len; i++) {
          rec = ref3[i];
          idx[rec.id = counter++] = rec;
        }
        this.resource[nm] = {
          idx: idx,
          counter: counter
        };
        this.endpoints["create" + nm] = {
          verb: 'post',
          route: "/Prototype/" + this.mod.name + "/" + nm,
          use: true,
          wrap: 'default_wrap',
          version: {
            any: this.proto_wrap(this.S_Create, nm)
          },
          sql_conn: true,
          sql_tx: true,
          auth_required: this.mod.auth_req
        };
        this.endpoints["update" + nm] = {
          verb: 'put',
          route: "/Prototype/" + this.mod.name + "/" + nm + "/:r0id/update",
          use: true,
          wrap: 'default_wrap',
          version: {
            any: this.proto_wrap(this.S_Update, nm)
          },
          sql_conn: true,
          sql_tx: true,
          auth_required: this.mod.auth_req
        };
        this.endpoints["delete" + nm] = {
          verb: 'del',
          route: "/Prototype/" + this.mod.name + "/" + nm + "/:r0id/delete",
          use: true,
          wrap: 'default_wrap',
          version: {
            any: this.proto_wrap(this.S_Delete, nm)
          },
          sql_conn: true,
          sql_tx: true,
          auth_required: this.mod.auth_req
        };
      }
    }

    PrototypeModule.prototype.proto_wrap = function(func, resource) {
      return function(ctx, pre_loaded) {
        return func(ctx, pre_loaded, resource);
      };
    };

    PrototypeModule.prototype.S_Get = function(ctx, pre_loaded) {
      var f, nm, result, use_doc;
      use_doc = {
        params: {},
        response: {
          success: 'bool',
          push: 'string'
        }
      };
      for (nm in this.resource) {
        use_doc.response[nm] = 'list';
      }
      if (ctx === 'use') {
        return use_doc;
      }
      f = "Prototype:S_Get:" + this.mod.name + ":";
      result = {};
      result[this.mod.name] = {};
      return Promise.resolve().bind(this).then(function() {
        var id, r_obj, rec, ref, ref1;
        ref = this.resource;
        for (nm in ref) {
          r_obj = ref[nm];
          result[this.mod.name][nm] = [];
          ref1 = r_obj.idx;
          for (id in ref1) {
            rec = ref1[id];
            result[this.mod.name][nm].push(rec);
          }
        }
        return this.pset.GetPushHandle(ctx, 0);
      }).then(function(push_handle) {
        result.push_handle = push_handle;
        result.success = true;
        return {
          send: result
        };
      });
    };

    PrototypeModule.prototype.S_Create = function(ctx, pre_loaded, resource) {
      var col, f, p, r, rec, result, schema, use_doc;
      use_doc = {
        params: this.mod.datasets[resource],
        response: {
          success: 'bool'
        }
      };
      use_doc.response[resource] = 'list';
      if (ctx === 'use') {
        return use_doc;
      }
      p = ctx.p;
      f = "Prototype:S_Create:" + this.mod.name + ":" + resource + ":";
      r = this.resource[resource];
      schema = this.mod.datasets[resource];
      rec = {};
      result = {};
      for (col in schema) {
        if (!(col in p)) {
          throw new this.E.MissingArg(col);
        }
        rec[col] = p[col];
      }
      rec.id = r.counter++;
      return Promise.resolve().bind(this).then(function() {
        r.idx[rec.id] = rec;
        result[resource] = [rec];
        return this.pset.ItemChange(ctx, 0, 'add', {}, rec, resource, rec.id, null);
      }).then(function() {
        result.success = true;
        return {
          send: result
        };
      });
    };

    PrototypeModule.prototype.S_Update = function(ctx, pre_loaded, resource) {
      var batch_ids, f, fn, i, id, j, len, len1, new_values, nm, p, q_result, r, r0id, result, schema, use_doc, val;
      use_doc = {
        params: this.mod.datasets[resource],
        response: {
          success: 'bool'
        }
      };
      use_doc.response[resource] = 'list';
      if (ctx === 'use') {
        return use_doc;
      }
      p = ctx.p;
      f = "Prototype:S_Update:" + this.mod.name + ":" + resource + ":";
      r = this.resource[resource];
      schema = this.mod.datasets[resource];
      new_values = {};
      result = {};
      if (p.r0id === 'batch') {
        if (!('batch_ids' in p)) {
          throw new this.E.MissingArg('batch_ids');
        }
        batch_ids = (function() {
          var i, len, ref, results;
          ref = p.batch_ids;
          results = [];
          for (i = 0, len = ref.length; i < len; i++) {
            id = ref[i];
            results.push(Number(id));
          }
          return results;
        })();
      } else {
        batch_ids = [Number(p.r0id)];
      }
      for (nm in p) {
        val = p[nm];
        if (nm in schema) {
          new_values[nm] = val;
        }
      }
      for (i = 0, len = batch_ids.length; i < len; i++) {
        r0id = batch_ids[i];
        if (!(r0id in r.idx)) {
          throw new this.E.NotFoundError("PROTO:UPDATE:" + this.mod.name + ":" + resource + ":r0id");
        }
      }
      result[resource] = [];
      q_result = Promise.resolve().bind(this);
      fn = function(r0id) {
        return q_result = q_result.then(function() {
          var before, vals;
          before = {};
          for (nm in new_values) {
            before[nm] = r.idx[r0id][nm];
          }
          r.idx[r0id] = _.merge(r.idx[r0id], new_values);
          result[resource].push(r.idx[r0id]);
          vals = _.clone(new_values);
          vals = _.merge(vals, {
            id: r0id
          });
          return this.pset.ItemChange(ctx, 0, 'update', before, vals, resource, r0id, null);
        }).then(function() {});
      };
      for (j = 0, len1 = batch_ids.length; j < len1; j++) {
        r0id = batch_ids[j];
        fn(r0id);
      }
      return q_result.then(function() {
        result.success = true;
        return {
          send: result
        };
      });
    };

    PrototypeModule.prototype.S_Delete = function(ctx, pre_loaded, resource) {
      var batch_ids, before, f, fn, i, id, j, len, len1, p, q_result, r, r0id, use_doc;
      use_doc = {
        params: {},
        response: {
          success: 'bool'
        }
      };
      if (ctx === 'use') {
        return use_doc;
      }
      p = ctx.p;
      f = "Prototype:S_Delete:" + this.mod.name + ":" + resource + ":";
      r = this.resource[resource];
      before = {};
      if (p.r0id === 'batch') {
        batch_ids = (function() {
          var i, len, ref, results;
          ref = p.batch_ids;
          results = [];
          for (i = 0, len = ref.length; i < len; i++) {
            id = ref[i];
            results.push(Number(id));
          }
          return results;
        })();
        if (!batch_ids.length) {
          throw new this.E.MissingArg('batch_ids');
        }
      } else {
        batch_ids = [Number(p.r0id)];
      }
      for (i = 0, len = batch_ids.length; i < len; i++) {
        r0id = batch_ids[i];
        if (!(r0id in r.idx)) {
          throw new this.E.NotFoundError("PROTO:DELETE:" + this.mod.name + ":" + resource + ":r0id", r0id);
        }
      }
      q_result = Promise.resolve().bind(this);
      fn = function(r0id) {
        return q_result = q_result.then(function() {
          delete r.idx["" + r0id];
          return this.pset.ItemChange(ctx, 0, 'delete', before, {}, resource, r0id, null);
        }).then(function() {});
      };
      for (j = 0, len1 = batch_ids.length; j < len1; j++) {
        r0id = batch_ids[j];
        fn(r0id);
      }
      return q_result.then(function() {
        return {
          send: {
            success: true
          }
        };
      });
    };

    return PrototypeModule;

  })();

  exports.Prototype = Prototype;

}).call(this);
