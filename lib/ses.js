// Generated by CoffeeScript 1.9.2
(function() {
  var AWS, Q, SES;

  Q = require('q');

  AWS = require('aws-sdk');

  SES = (function() {
    function SES(kit) {
      this.log = kit.services.logger.log;
      this.config = kit.services.config.ses;
      AWS.config.update({
        accessKeyId: this.config.accessKeyId,
        secretAccessKey: this.config.secretAccessKey,
        region: this.config.region
      });
      this.ses = new AWS.SES();
      this.template = kit.services.template;
    }

    SES.prototype.send = function(type, data) {
      var message, spec;
      spec = this.config.emails[type];
      message = this._composeMsgFrom(spec, data);
      this.log.debug('SES:send:', 'sending message:', message);
      return Q.ninvoke(this.ses, 'sendEmail', message);
    };

    SES.prototype._composeMsgFrom = function(spec, data) {
      var f, recipient, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, send_to;
      f = 'SES._composeMsgFrom:';
      this.log.debug(f, spec, data);
      send_to = false;
      if (this.config.debug_email !== false) {
        send_to = this.config.debug_email;
      } else {
        recipient = data.Recipient[0];
        send_to = typeof recipient === 'string' ? recipient : recipient.eml;
      }
      return {
        Destination: {
          ToAddresses: [send_to],
          BccAddresses: (ref = spec.BccAddresses) != null ? ref : this.config["default"].BccAddresses,
          CcAddresses: (ref1 = spec.CcAddresses) != null ? ref1 : this.config["default"].CcAddresses
        },
        Source: (ref2 = spec.Source) != null ? ref2 : this.config["default"].Source,
        ReplyToAddresses: (ref3 = spec.ReplyToAddresses) != null ? ref3 : this.config["default"].ReplyToAddresses,
        ReturnPath: (ref4 = spec.ReturnPath) != null ? ref4 : this.config["default"].ReturnPath,
        Message: {
          Subject: {
            Data: (ref5 = (ref6 = data.Subject) != null ? ref6 : spec.Subject) != null ? ref5 : 'Default Email Subject'
          },
          Body: {
            Html: {
              Data: this.template.render(spec.model, spec.tmpl, spec.page, data)
            },
            Text: {
              Data: (ref7 = spec.Text) != null ? ref7 : 'Default Email Text'
            }
          }
        }
      };
    };

    return SES;

  })();

  exports.SES = SES;

}).call(this);
