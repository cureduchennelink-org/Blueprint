// Generated by CoffeeScript 1.9.2
(function() {
  var Lamd, MongoClient, _,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  MongoClient = require('mongodb').MongoClient;

  _ = require('lodash');

  Lamd = (function() {
    Lamd.deps = {
      services: ['logger'],
      config: 'lamd'
    };

    function Lamd(kit) {
      this.read = bind(this.read, this);
      this.write = bind(this.write, this);
      this.server_init_promise = bind(this.server_init_promise, this);
      var f;
      f = 'Lamd:constructor';
      this.config = kit.services.config.lamd;
      this.log = kit.services.logger.log;
      this.db = false;
      this.collection_debug = false;
    }

    Lamd.prototype.server_init_promise = function(kit, promise_chain) {
      var f, server;
      f = 'Lamd:server_init:';
      server = kit.services.server.server;
      promise_chain = promise_chain.then((function(_this) {
        return function() {
          return MongoClient.connect(_this.config.connect_url, _this.config.options);
        };
      })(this));
      promise_chain = promise_chain.then((function(_this) {
        return function(db) {
          if (db != null) {
            _this.log.debug('Successfully connected to MongoDB database.');
          }
          _this.log.debug(f, _.pick(db.s, ['url', 'options']));
          if (db == null) {
            throw new Error(f + 'MongoDB connection is empty');
          }
          _this.db = db;
          return _this.collection_debug = db.db().collection('debug');
        };
      })(this));
      return promise_chain;
    };

    Lamd.prototype.write = function(data) {
      var err, f;
      f = 'Lamd:write:';
      try {
        return this._write(data);
      } catch (_error) {
        err = _error;
        return this.log.warn(f + 'err', err);
      }
    };

    Lamd.prototype._write = function(data) {
      var f;
      f = 'Lamd:_write:';
      return this.collection_debug.insertOne(data, {
        forceServerObjectId: true
      }, (function(_this) {
        return function(err, result) {
          if (err != null) {
            return _this.log.debug(f, {
              err: err,
              result: result
            });
          }
        };
      })(this));
    };

    Lamd.prototype.read = function(ctx, method, query, projection, options, hint, sort) {
      var f;
      f = 'Lamd-Custom:read:';
      ctx.log.debug(f, {
        method: method,
        query: query,
        projection: projection,
        options: options,
        hint: hint,
        sort: sort
      });
      if (method === "find") {
        query = (ctx.pool.db().collection("debug")).find(query).project(projection);
        if (sort) {
          query = query.sort(sort);
        }
        query = query.limit(100);
        if (hint) {
          query = query.hint(hint);
        }
        query = query.toArray();
        return query.then(function(docs) {
          ctx.log.debug(f, {
            docs: docs
          });
          return docs;
        });
      } else if (method === "aggregate") {
        query = (ctx.pool.db().collection("debug")).aggregate(query, options);
        query = query.toArray();
        return query.then(function(docs) {
          ctx.log.debug(f, {
            docs: docs
          });
          return docs;
        });
      }
    };

    return Lamd;

  })();

  exports.Lamd = Lamd;

}).call(this);
